#!/bin/sh

i915_drm_legacy_ids() {
cat <<END_DRM_LEGACY_IDS
0x3577
0x2562
0x3582
0x358e
0x2572
0x2582
0x258a
0x2592
0x2772
0x27a2
0x27ae
0x2972
0x2982
0x2992
0x29a2
0x29b2
0x29c2
0x29d2
0x2a02
0x2a12
0x2a42
0x2e02
0x2e12
0x2e22
0x2e32
0x2e42
0x2e92
0xa001
0xa011
0x0042
0x0046
END_DRM_LEGACY_IDS
}

i915_drm_next_ids() {
cat <<END_DRM_NEXT_IDS
0x0102
0x0112
0x0122
0x010A
0x0106
0x0116
0x0126
0x0156
0x0166
0x0152
0x0162
0x015a
0x016a
0x0402
0x0412
0x0422
0x040a
0x041a
0x042a
0x040B
0x041B
0x042B
0x040E
0x041E
0x042E
0x0C02
0x0C12
0x0C22
0x0C0A
0x0C1A
0x0C2A
0x0C0B
0x0C1B
0x0C2B
0x0C0E
0x0C1E
0x0C2E
0x0A02
0x0A12
0x0A22
0x0A0A
0x0A1A
0x0A2A
0x0A0B
0x0A1B
0x0A2B
0x0D02
0x0D12
0x0D22
0x0D0A
0x0D1A
0x0D2A
0x0D0B
0x0D1B
0x0D2B
0x0D0E
0x0D1E
0x0D2E
0x0406
0x0416
0x0426
0x0C06
0x0C16
0x0C26
0x0A06
0x0A16
0x0A26
0x0A0E
0x0A1E
0x0A2E
0x0D06
0x0D16
0x0D26
0x0f30
0x0f31
0x0f32
0x0f33
0x0157
0x0155
0x1602
0x1606
0x160B
0x160E
0x1612
0x1616
0x161B
0x161E
0x160A
0x160D
0x161A
0x161D
0x1622
0x1626
0x162B
0x162E
0x162A
0x162D
0x1632
0x1636
0x163B
0x163E
0x163A
0x163D
0x22b1
0x22b2
0x22b3
0x1906
0x190E
0x1902
0x190B
0x190A
0x1916
0x1921
0x191E
0x1912
0x191B
0x191A
0x191D
0x1923
0x1926
0x1927
0x192B
0x192A
0x1932
0x193B
0x193D
0x193A
0x0A84
0x1A84
0x1A85
0x5A84
0x5A85
0x5913
0x5915
0x5917
0x5906
0x590E
0x5902
0x5908
0x590B
0x590A
0x5916
0x5921
0x591E
0x5912
0x591B
0x591A
0x591D
0x5923
0x5926
0x5927
0x593B
END_DRM_NEXT_IDS
}

path_xorg_cfg="/usr/local/etc/X11/xorg.conf.d/10-intel.conf"
accel_method="sna"

xorg_cfg() {
cat << xorg_cfg_END
Section "Device"
    Identifier "Intel Graphics"
    Driver     "intel"
    Option     "AccelMethod"    "${accel_method}"
    Option     "TripleBuffer"   "true"
    Option     "HotPlug"        "true"
EndSection
xorg_cfg_END
}

unit=$(sysctl -n hw.pci.default_vgapci_unit)
config=$(pciconf -lv | grep ^vgapci${unit} | \
	sed -E 's#.* chip=0x([0-9a-z]{4})([0-9a-z]{4}).*$#\1:\2#')
for i in $config; do
	vendor=$(echo "$i" | cut -d: -f2)
	device=$(echo "$i" | cut -d: -f1)
	if [ "$vendor" = 8086 ]; then
		if i915_drm_legacy_ids | grep -iq ${device}; then
			accel_method="uxa"
			xorg_cfg > "${path_xorg_cfg}"
			kldconfig -im /boot/drm_legacy >/dev/null 2>&1
			kldload /boot/drm_legacy/i915kms.ko && exit 0
		fi
		if i915_drm_next_ids | grep -iq ${device}; then
			xorg_cfg > "${path_xorg_cfg}"
			kldload /boot/modules/i915kms.ko && exit 0
		fi
		exit 1
	fi
done
exit 1

