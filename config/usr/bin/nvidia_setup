#!/bin/sh

# vim: set tabstop=4:

data_390() {
cat << 390_END
GeForce 410M
GeForce 510
GeForce 605
GeForce 610M
GeForce 705M
GeForce 710M
GeForce 720M
GeForce 800M
GeForce 810M
GeForce 820M
GeForce 825M
GeForce 830M
GeForce 840M
GeForce 845M
GeForce 910M
GeForce 920M
GeForce 920MX
GeForce 930M
GeForce 930MX
GeForce 940M
GeForce 940MX
GeForce 945M
GeForce GT 1030
GeForce GT 415M
GeForce GT 420
GeForce GT 420M
GeForce GT 425M
GeForce GT 430
GeForce GT 435M
GeForce GT 440
GeForce GT 445M
GeForce GT 520
GeForce GT 520M
GeForce GT 520MX
GeForce GT 525M
GeForce GT 530
GeForce GT 540M
GeForce GT 545
GeForce GT 550M
GeForce GT 555M
GeForce GT 610
GeForce GT 620
GeForce GT 620M
GeForce GT 625M
GeForce GT 630
GeForce GT 630M
GeForce GT 635
GeForce GT 635M
GeForce GT 640
GeForce GT 640M
GeForce GT 640M LE
GeForce GT 645
GeForce GT 645M
GeForce GT 650M
GeForce GT 705
GeForce GT 710
GeForce GT 710M
GeForce GT 720
GeForce GT 720M
GeForce GT 730
GeForce GT 730M
GeForce GT 735M
GeForce GT 740
GeForce GT 740M
GeForce GT 745M
GeForce GT 750M
GeForce GT 755M
GeForce GTS 450
GeForce GTX 1050
GeForce GTX 1050 Ti
GeForce GTX 1060
GeForce GTX 1070
GeForce GTX 1070 Ti
GeForce GTX 1080
GeForce GTX 1080 Ti
GeForce GTX 460
GeForce GTX 460 SE
GeForce GTX 460 SE v2
GeForce GTX 460M
GeForce GTX 465
GeForce GTX 470
GeForce GTX 470M
GeForce GTX 480
GeForce GTX 480M
GeForce GTX 485M
GeForce GTX 550 Ti
GeForce GTX 555
GeForce GTX 560
GeForce GTX 560 SE
GeForce GTX 560 Ti
GeForce GTX 560M
GeForce GTX 570
GeForce GTX 570M
GeForce GTX 580
GeForce GTX 580M
GeForce GTX 590
GeForce GTX 645
GeForce GTX 650
GeForce GTX 650 Ti
GeForce GTX 650 Ti BOOST
GeForce GTX 660
GeForce GTX 660 Ti
GeForce GTX 660M
GeForce GTX 670
GeForce GTX 670M
GeForce GTX 670MX
GeForce GTX 675M
GeForce GTX 675MX
GeForce GTX 680
GeForce GTX 680M
GeForce GTX 680MX
GeForce GTX 690
GeForce GTX 745
GeForce GTX 750
GeForce GTX 750 Ti
GeForce GTX 760
GeForce GTX 760 Ti (OEM)
GeForce GTX 760M
GeForce GTX 765M
GeForce GTX 770
GeForce GTX 770M
GeForce GTX 780
GeForce GTX 780 Ti
GeForce GTX 780M
GeForce GTX 850M
GeForce GTX 860M
GeForce GTX 870M
GeForce GTX 880M
GeForce GTX 950
GeForce GTX 950M
GeForce GTX 960
GeForce GTX 960M
GeForce GTX 965M
GeForce GTX 970
GeForce GTX 970M
GeForce GTX 980
GeForce GTX 980 Ti
GeForce GTX 980M
GeForce GTX TITAN
GeForce GTX TITAN Black
GeForce GTX TITAN X
GeForce GTX TITAN Z
GeForce MX110
GeForce MX130
GeForce MX150
NVIDIA TITAN V
NVIDIA TITAN X (Pascal)
NVIDIA TITAN Xp
NVS 310
NVS 315
NVS 4200M
NVS 510
NVS 5200M
NVS 5400M
NVS 810
Quadro 1000M
Quadro 2000
Quadro 2000D
Quadro 2000M
Quadro 3000M
Quadro 4000 for Mac
Quadro 4000M
Quadro 5000
Quadro 5000M
Quadro 5010M
Quadro 600
Quadro 6000
Quadro G-Sync II
Quadro GP100
Quadro K1000M
Quadro K1100M
Quadro K1200
Quadro K2000
Quadro K2000D
Quadro K2000M
Quadro K2100M
Quadro K2200
Quadro K2200M
Quadro K3000M
Quadro K3100M
Quadro K4000
Quadro K4000M
Quadro K4100M
Quadro K420
Quadro K4200
Quadro K5000
Quadro K5000 for Mac
Quadro K5000M
Quadro K500M
Quadro K5100M
Quadro K510M
Quadro K5200
Quadro K600
Quadro K610M
Quadro K620
Quadro K620M
Quadro M1000M
Quadro M1200
Quadro M2000
Quadro M2000M
Quadro M2200
Quadro M3000 SE
Quadro M3000M
Quadro M4000
Quadro M4000M
Quadro M5000
Quadro M5000 SE
Quadro M5000M
Quadro M500M
Quadro M520
Quadro M5500
Quadro M6000
Quadro M6000 24GB
Quadro M600M
Quadro M620
Quadro P1000
Quadro P2000
Quadro P3000
Quadro P400
Quadro P4000
Quadro P500
Quadro P5000
Quadro P600
Quadro P6000
Quadro Plex 7000
Quadro SDI
Quadro Sync
Quadro Sync II
390_END
}

data_340() {
cat << 340_END
GeForce 205
GeForce 210
GeForce 305M
GeForce 310
GeForce 310M
GeForce 315
GeForce 315M
GeForce 320M
GeForce 405
GeForce 405M
GeForce 410M
GeForce 510
GeForce 605
GeForce 610M
GeForce 705M
GeForce 710M
GeForce 720M
GeForce 8100 /nForce 720a
GeForce 810M
GeForce 8200
GeForce 8200M
GeForce 8200M G
GeForce 820M
GeForce 825M
GeForce 8300
GeForce 8300 GS
GeForce 830M
GeForce 8400
GeForce 8400 GS
GeForce 8400 SE
GeForce 8400M G
GeForce 8400M GS
GeForce 8400M GT
GeForce 840M
GeForce 845M
GeForce 8500 GT
GeForce 8600 GS
GeForce 8600 GT
GeForce 8600 GTS
GeForce 8600M GS
GeForce 8600M GT
GeForce 8700M GT
GeForce 8800 GS
GeForce 8800 GT
GeForce 8800 GTS
GeForce 8800 GTS 512
GeForce 8800 GTX
GeForce 8800 Ultra
GeForce 8800M GTS
GeForce 8800M GTX
GeForce 9100
GeForce 9100M G
GeForce 9200
GeForce 9200M GS
GeForce 9300
GeForce 9300 GE
GeForce 9300 GS
GeForce 9300 SE
GeForce 9300M G
GeForce 9300M GS
GeForce 9400
GeForce 9400 GT
GeForce 9400M
GeForce 9400M G
GeForce 9500 GS
GeForce 9500 GT
GeForce 9500M G
GeForce 9500M GS
GeForce 9600 GS
GeForce 9600 GSO
GeForce 9600 GSO 512
GeForce 9600 GT
GeForce 9600M GS
GeForce 9600M GT
GeForce 9650M GS
GeForce 9650M GT
GeForce 9700M GT
GeForce 9700M GTS
GeForce 9800 GT
GeForce 9800 GTX/GTX+
GeForce 9800 GX2
GeForce 9800M GS
GeForce 9800M GT
GeForce 9800M GTS
GeForce 9800M GTX
GeForce G 102M
GeForce G 103M
GeForce G 105M
GeForce G 110M
GeForce G100
GeForce G205M
GeForce G210
GeForce G210M
GeForce GT 120
GeForce GT 120M
GeForce GT 130
GeForce GT 130M
GeForce GT 140
GeForce GT 220
GeForce GT 220M
GeForce GT 230
GeForce GT 230M
GeForce GT 240
GeForce GT 240M
GeForce GT 320
GeForce GT 320M
GeForce GT 325M
GeForce GT 330
GeForce GT 330M
GeForce GT 335M
GeForce GT 340
GeForce GT 415M
GeForce GT 420
GeForce GT 420M
GeForce GT 425M
GeForce GT 430
GeForce GT 435M
GeForce GT 440
GeForce GT 445M
GeForce GT 520
GeForce GT 520M
GeForce GT 520MX
GeForce GT 525M
GeForce GT 530
GeForce GT 540M
GeForce GT 545
GeForce GT 550M
GeForce GT 555M
GeForce GT 610
GeForce GT 620
GeForce GT 620M
GeForce GT 625M
GeForce GT 630
GeForce GT 630M
GeForce GT 635
GeForce GT 635M
GeForce GT 640
GeForce GT 640M
GeForce GT 640M LE
GeForce GT 645
GeForce GT 645M
GeForce GT 650M
GeForce GT 705
GeForce GT 710
GeForce GT 710M
GeForce GT 720
GeForce GT 720M
GeForce GT 730
GeForce GT 730M
GeForce GT 735M
GeForce GT 740
GeForce GT 740M
GeForce GT 745M
GeForce GT 750M
GeForce GT 755M
GeForce GTS 150M
GeForce GTS 160M
GeForce GTS 240
GeForce GTS 250
GeForce GTS 250M
GeForce GTS 260M
GeForce GTS 350M
GeForce GTS 360M
GeForce GTS 450
GeForce GTX 260
GeForce GTX 260M
GeForce GTX 275
GeForce GTX 280
GeForce GTX 280M
GeForce GTX 285
GeForce GTX 285M
GeForce GTX 295
GeForce GTX 460
GeForce GTX 460 SE
GeForce GTX 460 SE v2
GeForce GTX 460M
GeForce GTX 465
GeForce GTX 470
GeForce GTX 470M
GeForce GTX 480
GeForce GTX 480M
GeForce GTX 485M
GeForce GTX 550 Ti
GeForce GTX 555
GeForce GTX 560
GeForce GTX 560 SE
GeForce GTX 560 Ti
GeForce GTX 560M
GeForce GTX 570
GeForce GTX 570M
GeForce GTX 580
GeForce GTX 580M
GeForce GTX 590
GeForce GTX 645
GeForce GTX 650
GeForce GTX 650 Ti
GeForce GTX 650 Ti BOOST
GeForce GTX 660
GeForce GTX 660 Ti
GeForce GTX 660M
GeForce GTX 670
GeForce GTX 670M
GeForce GTX 670MX
GeForce GTX 675M
GeForce GTX 675MX
GeForce GTX 680
GeForce GTX 680M
GeForce GTX 680MX
GeForce GTX 690
GeForce GTX 745
GeForce GTX 750
GeForce GTX 750 Ti
GeForce GTX 760
GeForce GTX 760 Ti (OEM)
GeForce GTX 760M
GeForce GTX 765M
GeForce GTX 770
GeForce GTX 770M
GeForce GTX 780
GeForce GTX 780 Ti
GeForce GTX 780M
GeForce GTX 850M
GeForce GTX 860M
GeForce GTX 870M
GeForce GTX 880M
GeForce GTX TITAN
GeForce GTX TITAN Black
GeForce GTX TITAN Z
GRID K2
GRID K520
ION
ION LE
NVS 2100M
NVS 300
NVS 310
NVS 3100M
NVS 315
NVS 4200M
NVS 510
NVS 5100M
NVS 5200M
NVS 5400M
Quadro 1000M
Quadro 2000
Quadro 2000D
Quadro 2000M
Quadro 3000M
Quadro 400
Quadro 4000
Quadro 4000M
Quadro 410
Quadro 5000
Quadro 5000M
Quadro 5010M
Quadro 600
Quadro 6000
Quadro CX
Quadro FX 1600M
Quadro FX 1700
Quadro FX 1700M
Quadro FX 1800
Quadro FX 1800M
Quadro FX 2700M
Quadro FX 2800M
Quadro FX 3600M
Quadro FX 360M
Quadro FX 370
Quadro FX 370 Low Profile
Quadro FX 3700
Quadro FX 3700M
Quadro FX 370M
Quadro FX 380
Quadro FX 380 Low Profile
Quadro FX 3800
Quadro FX 3800M
Quadro FX 380M
Quadro FX 4600
Quadro FX 4700 X2
Quadro FX 4800
Quadro FX 5600
Quadro FX 570
Quadro FX 570M
Quadro FX 580
Quadro FX 5800
Quadro FX 770M
Quadro FX 880M
Quadro G-Sync II
Quadro K1000M
Quadro K1100M
Quadro K2000
Quadro K2000D
Quadro K2000M
Quadro K2100M
Quadro K2200
Quadro K3000M
Quadro K3100M
Quadro K4000
Quadro K4000M
Quadro K4100M
Quadro K420
Quadro K4200
Quadro K5000
Quadro K5000M
Quadro K500M
Quadro K5100M
Quadro K510M
Quadro K5200
Quadro K600
Quadro K6000
Quadro K610M
Quadro K620
Quadro NVS 130M
Quadro NVS 135M
Quadro NVS 140M
Quadro NVS 150M
Quadro NVS 160M
Quadro NVS 290
Quadro NVS 295
Quadro NVS 320M
Quadro NVS 420
Quadro NVS 450
Quadro Plex 7000
Quadro Plex D Series
Quadro Plex Model II
Quadro Plex Model IV
Quadro SDI
Quadro Sync
340_END
}

data_304() {
cat << 304_END
GeForce 205
GeForce 210
GeForce 305M
GeForce 310
GeForce 310M
GeForce 315
GeForce 315M
GeForce 320M
GeForce 405
GeForce 410M
GeForce 510
GeForce 605
GeForce 6100
GeForce 6100 nForce 400
GeForce 6100 nForce 405
GeForce 6100 nForce 420
GeForce 610M
GeForce 6150
GeForce 6150 LE
GeForce 6150LE / Quadro NVS 210S 
GeForce 6150SE nForce 430
GeForce 6200
GeForce 6200 A-LE
GeForce 6200 LE
GeForce 6200 TurboCache(TM)
GeForce 6200SE TurboCache(TM)
GeForce 6250
GeForce 6500
GeForce 6600
GeForce 6600 GT
GeForce 6600 LE
GeForce 6600 VE
GeForce 6610 XL
GeForce 6700 XL
GeForce 6800
GeForce 6800 GS
GeForce 6800 GS/XT
GeForce 6800 GT
GeForce 6800 LE
GeForce 6800 Ultra
GeForce 6800 XE
GeForce 6800 XT
GeForce 7000M / nForce 610M
GeForce 7025 / NVIDIA nForce 630a
GeForce 7050 / NVIDIA nForce 610i
GeForce 7050 / NVIDIA nForce 630i
GeForce 7050 PV / NVIDIA nForce 630a
GeForce 7100 / NVIDIA nForce 620i
GeForce 7100 / NVIDIA nForce 630i
GeForce 7100 GS
GeForce 7150 / NVIDIA nForce 630i
GeForce 7150M / nForce 630M
GeForce 7300 GS
GeForce 7300 GT
GeForce 7300 LE
GeForce 7300 SE / 7200 GS
GeForce 7350 LE
GeForce 7500 LE
GeForce 7550 LE
GeForce 7600 GS
GeForce 7600 GT
GeForce 7600 LE
GeForce 7650 GS
GeForce 7800 GS
GeForce 7800 GT
GeForce 7800 GTX
GeForce 7800 SLI
GeForce 7900 GS
GeForce 7900 GT/GTO
GeForce 7900 GTX
GeForce 7950 GT
GeForce 7950 GX2
GeForce 8100 /nForce 720a
GeForce 8200
GeForce 8200 /nForce 730a
GeForce 8200M
GeForce 8200M G
GeForce 8300
GeForce 8300 GS
GeForce 8400
GeForce 8400 GS
GeForce 8400 SE
GeForce 8400M G
GeForce 8400M GS
GeForce 8400M GT
GeForce 8500 GT
GeForce 8600 GS
GeForce 8600 GT
GeForce 8600 GTS
GeForce 8600M GS
GeForce 8600M GT
GeForce 8700M GT
GeForce 8800 GS
GeForce 8800 GT
GeForce 8800 GTS
GeForce 8800 GTS 512
GeForce 8800 GTX
GeForce 8800 Ultra
GeForce 8800M GTS
GeForce 8800M GTX
GeForce 9100
GeForce 9100M G
GeForce 9200
GeForce 9200M GS
GeForce 9300
GeForce 9300 GE
GeForce 9300 GS
GeForce 9300 SE
GeForce 9300M G
GeForce 9300M GS
GeForce 9400
GeForce 9400 GT
GeForce 9400M
GeForce 9400M G
GeForce 9500 GS
GeForce 9500 GT
GeForce 9500M G
GeForce 9500M GS
GeForce 9600 GS
GeForce 9600 GSO
GeForce 9600 GSO 512
GeForce 9600 GT
GeForce 9600M GS
GeForce 9600M GT
GeForce 9650M GS
GeForce 9650M GT
GeForce 9700M GT
GeForce 9700M GTS
GeForce 9800 GT
GeForce 9800 GTX/GTX+
GeForce 9800 GX2
GeForce 9800M GS
GeForce 9800M GT
GeForce 9800M GTS
GeForce 9800M GTX
GeForce G 102M
GeForce G 103M
GeForce G 105M
GeForce G 110M
GeForce G100
GeForce G210
GeForce G210M
GeForce Go 7200
GeForce Go 7300
GeForce Go 7400
GeForce Go 7600
GeForce Go 7700
GeForce Go 7800
GeForce Go 7800 GTX
GeForce Go 7900 GS
GeForce Go 7950 GTX
GeForce GT 120
GeForce GT 120M
GeForce GT 130
GeForce GT 130M
GeForce GT 140
GeForce GT 220
GeForce GT 220M
GeForce GT 230
GeForce GT 230M
GeForce GT 240
GeForce GT 240M
GeForce GT 320
GeForce GT 320M
GeForce GT 325M
GeForce GT 330
GeForce GT 330M
GeForce GT 335M
GeForce GT 340
GeForce GT 415M
GeForce GT 420
GeForce GT 420M
GeForce GT 425M
GeForce GT 430
GeForce GT 435M
GeForce GT 440
GeForce GT 445M
GeForce GT 520
GeForce GT 520M
GeForce GT 520MX
GeForce GT 525M
GeForce GT 530
GeForce GT 540M
GeForce GT 545
GeForce GT 550M
GeForce GT 555M
GeForce GT 610
GeForce GT 620
GeForce GT 620M
GeForce GT 630
GeForce GT 630M
GeForce GT 635M
GeForce GT 640
GeForce GT 640M
GeForce GT 640M LE
GeForce GT 645
GeForce GT 645M
GeForce GT 650M
GeForce GTS 150M
GeForce GTS 160M
GeForce GTS 240
GeForce GTS 250
GeForce GTS 250M
GeForce GTS 260M
GeForce GTS 350M
GeForce GTS 360M
GeForce GTS 450
GeForce GTX 260
GeForce GTX 260M
GeForce GTX 275
GeForce GTX 280
GeForce GTX 280M
GeForce GTX 285
GeForce GTX 285M
GeForce GTX 295
GeForce GTX 460
GeForce GTX 460 SE
GeForce GTX 460 SE v2
GeForce GTX 460M
GeForce GTX 465
GeForce GTX 470
GeForce GTX 470M
GeForce GTX 480
GeForce GTX 480M
GeForce GTX 485M
GeForce GTX 550 Ti
GeForce GTX 555
GeForce GTX 560
GeForce GTX 560 SE
GeForce GTX 560 Ti
GeForce GTX 560M
GeForce GTX 570
GeForce GTX 570M
GeForce GTX 580
GeForce GTX 580M
GeForce GTX 590
GeForce GTX 650
GeForce GTX 650 Ti
GeForce GTX 660
GeForce GTX 660 Ti
GeForce GTX 660M
GeForce GTX 670
GeForce GTX 670M
GeForce GTX 670MX
GeForce GTX 675M
GeForce GTX 675MX
GeForce GTX 680
GeForce GTX 680M
GeForce GTX 690
GRID K1
GRID K2
ION
ION LE
NVS 2100M
NVS 300
NVS 310
NVS 3100M
NVS 4200M
NVS 510
NVS 5100M
NVS 5200M
NVS 5400M
Quadro 1000M
Quadro 2000
Quadro 2000D
Quadro 2000M
Quadro 3000M
Quadro 400
Quadro 4000
Quadro 4000M
Quadro 410
Quadro 5000
Quadro 5000M
Quadro 5010M
Quadro 600
Quadro 6000
Quadro CX
Quadro FX 1400
Quadro FX 1500
Quadro FX 1600M
Quadro FX 1700
Quadro FX 1700M
Quadro FX 1800
Quadro FX 1800M
Quadro FX 2000
Quadro FX 2700M
Quadro FX 2800M
Quadro FX 3450
Quadro FX 350
Quadro FX 3500
Quadro FX 3600M
Quadro FX 360M
Quadro FX 370
Quadro FX 370 Low Profile
Quadro FX 3700
Quadro FX 3700M
Quadro FX 380
Quadro FX 380 Low Profile
Quadro FX 3800
Quadro FX 3800M
Quadro FX 380M
Quadro FX 4000
Quadro FX 4500
Quadro FX 4500 X2
Quadro FX 4600
Quadro FX 470
Quadro FX 4700 X2
Quadro FX 4800
Quadro FX 540
Quadro FX 550
Quadro FX 5500
Quadro FX 560
Quadro FX 5600
Quadro FX 570
Quadro FX 570M
Quadro FX 580
Quadro FX 5800
Quadro FX 770M
Quadro FX 880M
Quadro G-Sync II
Quadro K1000M
Quadro K2000M
Quadro K3000M
Quadro K4000M
Quadro K5000
Quadro K5000M
Quadro NVS 110M
Quadro NVS 120M
Quadro NVS 130M
Quadro NVS 135M
Quadro NVS 140M
Quadro NVS 150M
Quadro NVS 160M
Quadro NVS 285
Quadro NVS 290
Quadro NVS 295
Quadro NVS 320M
Quadro NVS 420
Quadro NVS 440
Quadro NVS 450
Quadro NVS 510M
Quadro Plex 7000
Quadro Plex D Series
Quadro Plex Model II
Quadro Plex Model IV
Quadro SDI
Quadro Sync
304_END
}

find_driver() {
	config=$(pciconf -lv | grep -B3 display | grep device | cut -d"'" -f 2)
	for i in 390 340 304; do
		data_${i} | while read ln; do
			if (echo $config | grep -q -i -w "$ln"); then
				echo $i | cut -d. -f 1
				exit 100
			fi
		done
		[ $? -eq 100 ] && return
	done
}

driver=$(find_driver)

if [ -z "${driver}" ]; then
	# No NVIDIA device
	rm -f /usr/local/etc/X11/xorg.conf.d/10-nvidia.conf > /dev/null 2>&1
	exit 0
fi
	
[ ! -d /usr/local/etc/libmap.d ] && mkdir /usr/local/etc/libmap.d

if [ ! -f /usr/local/etc/libmap.d/nvidia.conf ]; then
	cmp /usr/local/nvidia/${driver}/usr/local/etc/libmap.d/nvidia.conf \
	    /usr/local/etc/libmap.d/nvidia.conf || \
	cp /usr/local/nvidia/${driver}/usr/local/etc/libmap.d/nvidia.conf \
	   /usr/local/etc/libmap.d
fi
ldconfig -m /usr/local/nvidia/${driver}/usr/local/lib
mount_unionfs -o noatime \
    /usr/local/nvidia/${driver}/usr/local/lib/xorg/modules/drivers \
    /usr/local/lib/xorg/modules/drivers
mount_unionfs -o noatime \
    /usr/local/nvidia/${driver}/usr/local/lib/xorg/modules/extensions \
    /usr/local/lib/xorg/modules/extensions
mount_unionfs -o noatime /usr/local/nvidia/${driver}/boot /boot
mount_unionfs -o noatime /usr/local/nvidia/${driver}/compat /compat

if [ ${driver} -eq 390 ]; then
	kldload nvidia
	kldload nvidia-modeset
else
	# Just in case there are nvidia modules loaded
	kldunload nvidia >/dev/null 2>&1
	kldunload nvidia-modeset >/dev/null 2>&1

	# nvidia 340 or 304 driver needed
	kldload nvidia
fi
if [ ! -f /usr/local/etc/X11/xorg.conf.d/10-nvidia.conf ]; then
	cp /root/10-nvidia.conf /usr/local/etc/X11/xorg.conf.d/
fi

exit 0

